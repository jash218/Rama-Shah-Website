<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rama Rachna - Blog</title>
  <link rel="stylesheet" href="css/blogstyle.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>marked.setOptions({ breaks: true });</script>
  <style>
    :root {
      --header-height: 10vh;
      --nav-height:    5vh;
    }
    main {
      padding: calc(var(--header-height) + var(--nav-height)) 1rem 2rem;
    }
    .blog-post {
      position: relative;
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      border: 2px solid #F7ECD7;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: box-shadow 0.3s ease;
    }
    .blog-post:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    .post-content {
      display: none;
      margin-top: 1rem;
    }
    .collapse-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      color: #7D615B;
    }
    .comment-section {
      background: #FDF6E1;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
    }
    .comment-item {
      margin-bottom: 1rem;
      padding-left: 1rem;
      border-left: 2px solid #ddd;
    }
    .comment-item p {
      margin: 0;
    }
    .comment-item .meta {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 0.3rem;
    }
    .comment-item .actions button {
      background: #7D615B;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    .comment-form, .reply-form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .comment-form textarea,
    .reply-form textarea {
      flex: 1 1 100%;
      min-height: 4rem;
      padding: 0.5rem;
    }
    .comment-form input,
    .reply-form input {
      flex: 1 1 calc(33% - 1rem);
      min-width: 8rem;
      padding: 0.5rem;
    }
    .comment-form button,
    .reply-form button {
      flex: 0 0 auto;
      padding: 0.5rem 1rem;
      background: #7D615B;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .loading, .error {
      text-align: center;
      margin: 2rem 0;
      color: #666;
    }
    .error { color: #b00; }
  </style>

  <!-- Markdown spacing overrides -->
  <style>
    .post-markdown p {
      margin: 1rem 0 !important;
      line-height: 1.6 !important;
    }
    .post-markdown br {
      display: block !important;
      margin-bottom: 1rem !important;
    }
  </style>

</head>
<body>
  <header style="position:fixed;top:0;width:100%;height:var(--header-height);background:#FDF6E1;display:flex;align-items:center;justify-content:space-between;padding:0 1rem;border-bottom:1px solid #ccc;z-index:1000;">
    <div class="branding" style="display:flex;align-items:center;">
      <img src="assets/rama rachna.png" alt="Rama Rachna Logo" style="height:40px;margin-right:10px;">
      <h1 style="color:#7D615B;">Rama Rachna</h1>
    </div>
    <!--<div class="toggle-switch">
      <input type="checkbox" id="lang-toggle">
      <label for="lang-toggle" class="toggle-slider"></label>
    </div> -->
  </header>
  <nav style="position:fixed;top:var(--header-height);width:100%;height:var(--nav-height);background:#F8EDD9;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #ccc;z-index:999;">
    <a href="index.html" class="nav-item" data-en="Home" data-gu="‡™π‡´ã‡™Æ">Home</a>
    <a href="author-pub.html" class="nav-item" data-en="Publications" data-gu="‡™™‡´ç‡™∞‡™ï‡™æ‡™∂‡™®‡´ã ‡™Ö‡™®‡´Å‡™ï‡´ç‡™∞‡™Æ‡™£‡™ø‡™ï‡™æ">Publications</a>
    <a href="about.html" class="nav-item" data-en="About" data-gu="‡™µ‡™ø‡™∂‡´á">About</a>
    <a href="photo-gallery.html" class="nav-item" data-en="Gallery" data-gu="‡™ó‡´á‡™≤‡´á‡™∞‡´Ä">Gallery</a>
    <a href="blog.html" class="nav-item" data-en="Blog" data-gu="‡™¨‡´ç‡™≤‡´ã‡™ó">Blog</a>
  </nav>
  <main>
    <section id="blog-container">
      <p class="loading">Loading posts‚Ä¶</p>
    </section>
  </main>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    document.body.style.opacity = '1';
    const container = document.getElementById('blog-container');

    function showError(msg) {
      container.innerHTML = `<p class="error">‚ö†Ô∏è ${msg}</p>`;
    }

    async function fetchPosts() {
      try {
        const res = await fetch('http://localhost:3000/api/posts');
        if (!res.ok) throw new Error(res.status);
        const posts = await res.json();
        if (!posts.length) return showError('No posts.');

        container.innerHTML = posts.map(p => `
          <article class="blog-post" data-id="${p._id}">
            <h2>${p.title}</h2>
            <p><em>By ${p.author} ‚Ä¢ ${new Date(p.createdAt).toLocaleDateString()}</em></p>
            <div class="post-content" id="post-${p._id}">
              <button class="collapse-btn" onclick="togglePost('${p._id}')">‚àí</button>
              <div class="post-markdown">${marked.parse(p.body)}</div>
              <section class="comment-section">
                <h3>üí¨ Comments</h3><br>
                <div id="comments-${p._id}">Loading comments‚Ä¶</div>
                <div class="comment-form" id="form-${p._id}">
                  <textarea placeholder="Leave a comment‚Ä¶"></textarea>
                  <button type="button" onclick="startComment('${p._id}')">Post Comment</button>
                </div>
              </section>
            </div>
          </article>
        `).join('');

        document.querySelectorAll('.blog-post').forEach(card => {
          card.addEventListener('click', e => {
            const id = card.dataset.id;
            const content = document.getElementById(`post-${id}`);
            if (content.style.display !== 'block' && !e.target.closest('textarea, input, button')) {
              togglePost(id);
            }
          });
        });
      } catch (e) {
        console.error(e);
        showError('Failed to load.');
      }
    }

    window.togglePost = id => {
      const content = document.getElementById(`post-${id}`);
      if (!content) return;
      const show = content.style.display !== 'block';
      content.style.display = show ? 'block' : 'none';
      if (show) loadComments(id);
    };

    async function loadComments(postId) {
      const res = await fetch(`http://localhost:3000/api/comments/${postId}`);
      if (!res.ok) return;
      const comments = await res.json();
      const map = {};
      comments.forEach(c => {
        (map[c.parentId || 'root'] = map[c.parentId || 'root'] || []).push(c);
      });

      const ctn = document.getElementById(`comments-${postId}`);
      ctn.innerHTML = '';

      function render(pid, depth=0) {
        (map[pid] || []).forEach(c => {
          const d = document.createElement('div');
          d.className = 'comment-item';
          d.style.marginLeft = `${depth * 1.5}rem`;
          d.innerHTML = `
            <div class="meta">
              <strong>${c.isAuthor ? 'Author ‚≠ê' : c.name}</strong>
              <span> ‚Ä¢ ${new Date(c.createdAt).toLocaleString()}</span>
            </div>
            <p>${c.text}</p>
            <div class="actions">
              <button type="button" onclick="startReply('${postId}','${c._id}')">Reply</button>
            </div>
            <div id="reply-${c._id}" class="reply-form"></div>
          `;
          ctn.appendChild(d);
          render(c._id, depth + 1);
        });
      }

      render('root');
    }

    window.startComment = postId => {
      const f = document.getElementById(`form-${postId}`);
      f.querySelector('button').style.display = 'none';
      const name = document.createElement('input');
      name.type='text'; name.placeholder='Your Name'; name.required=true;
      const email = document.createElement('input');
      email.type='email'; email.placeholder='Your Email'; email.required=true;
      email.pattern=".+@.+\\.com";
      const submit = document.createElement('button');
      submit.textContent='Submit'; submit.addEventListener('click', ()=>submitComment(postId,null));
      f.append(name, email, submit);
    };

    window.startReply = (postId, parentId) => {
      const box = document.getElementById(`reply-${parentId}`);
      box.innerHTML = '';
      const ta = document.createElement('textarea');
      ta.placeholder='Your reply‚Ä¶';
      const nm = document.createElement('input');
      nm.type='text'; nm.placeholder='Your Name'; nm.required=true;
      const em = document.createElement('input');
      em.type='email'; em.placeholder='Your Email'; em.required=true;
      em.pattern=".+@.+\\.com";
      const btn = document.createElement('button');
      btn.textContent='Submit Reply';
      btn.addEventListener('click', ()=>submitComment(postId,parentId));
      box.append(ta, nm, em, btn);
    };

    async function submitComment(postId, parentId) {
      const box = parentId
        ? document.getElementById(`reply-${parentId}`)
        : document.getElementById(`form-${postId}`);
      const txt = box.querySelector('textarea').value.trim();
      const nm  = box.querySelector('input[type="text"]').value.trim();
      const em  = box.querySelector('input[type="email"]').value.trim();
      if (!txt || !nm || !em) return alert('All fields required.');
      const res = await fetch('http://localhost:3000/api/comments', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ postId, parentId, text: txt, name: nm, email: em })
      });
      if (res.ok) {
        loadComments(postId);
        if (!parentId) {
          const f = document.getElementById(`form-${postId}`);
          f.querySelector('textarea').value = '';
          f.querySelector('button').style.display = '';
          f.querySelectorAll('input').forEach(i => i.remove());
        } else {
          box.innerHTML = '';
        }
      } else alert('Error posting.');
    }

    fetchPosts();
  });
  </script>

  <script>
(function () {
  const current = location.pathname.split('/').pop() || 'index.html';
  document.querySelectorAll('nav .nav-item').forEach(a => {
    if (a.getAttribute('href') === current) {
      a.classList.add('active');
      a.setAttribute('aria-current', 'page');
    }
  });
})();
</script>

  